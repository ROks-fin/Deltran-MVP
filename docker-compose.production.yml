version: '3.8'

services:
  # ============================================================================
  # Gateway Layer (3 replicas for high availability)
  # ============================================================================

  gateway-1:
    build:
      context: ./gateway-go
      dockerfile: Dockerfile
    container_name: deltran-gateway-1
    restart: always
    ports:
      - "8080:8080"
      - "9090:9090"  # Metrics
    environment:
      - GATEWAY_ID=gateway-1
      - GATEWAY_PORT=8080
      - METRICS_PORT=9090
      - LEDGER_GRPC_ADDR=ledger-1:50051,ledger-2:50052,ledger-3:50053
      - WORKER_COUNT=1000
      - QUEUE_SIZE=10000
      - LOG_LEVEL=info
      - TLS_ENABLED=true
      - TLS_CERT_PATH=/certs/gateway.crt
      - TLS_KEY_PATH=/certs/gateway.key
      - TLS_CA_CERT_PATH=/certs/ca.crt
    volumes:
      - ./certs:/certs:ro
      - gateway-1-logs:/var/log/deltran
    networks:
      - deltran-network
    depends_on:
      - ledger-1
      - ledger-2
      - ledger-3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  gateway-2:
    build:
      context: ./gateway-go
      dockerfile: Dockerfile
    container_name: deltran-gateway-2
    restart: always
    ports:
      - "8081:8080"
      - "9091:9090"
    environment:
      - GATEWAY_ID=gateway-2
      - GATEWAY_PORT=8080
      - METRICS_PORT=9090
      - LEDGER_GRPC_ADDR=ledger-1:50051,ledger-2:50052,ledger-3:50053
      - WORKER_COUNT=1000
      - QUEUE_SIZE=10000
      - LOG_LEVEL=info
      - TLS_ENABLED=true
      - TLS_CERT_PATH=/certs/gateway.crt
      - TLS_KEY_PATH=/certs/gateway.key
      - TLS_CA_CERT_PATH=/certs/ca.crt
    volumes:
      - ./certs:/certs:ro
      - gateway-2-logs:/var/log/deltran
    networks:
      - deltran-network
    depends_on:
      - ledger-1
      - ledger-2
      - ledger-3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  gateway-3:
    build:
      context: ./gateway-go
      dockerfile: Dockerfile
    container_name: deltran-gateway-3
    restart: always
    ports:
      - "8082:8080"
      - "9092:9090"
    environment:
      - GATEWAY_ID=gateway-3
      - GATEWAY_PORT=8080
      - METRICS_PORT=9090
      - LEDGER_GRPC_ADDR=ledger-1:50051,ledger-2:50052,ledger-3:50053
      - WORKER_COUNT=1000
      - QUEUE_SIZE=10000
      - LOG_LEVEL=info
      - TLS_ENABLED=true
      - TLS_CERT_PATH=/certs/gateway.crt
      - TLS_KEY_PATH=/certs/gateway.key
      - TLS_CA_CERT_PATH=/certs/ca.crt
    volumes:
      - ./certs:/certs:ro
      - gateway-3-logs:/var/log/deltran
    networks:
      - deltran-network
    depends_on:
      - ledger-1
      - ledger-2
      - ledger-3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  # ============================================================================
  # Ledger Layer (3 replicas)
  # ============================================================================

  ledger-1:
    build:
      context: ./ledger-core
      dockerfile: Dockerfile
    container_name: deltran-ledger-1
    restart: always
    ports:
      - "50051:50051"  # gRPC
      - "9100:9100"    # Metrics
    environment:
      - LEDGER_ID=ledger-1
      - GRPC_PORT=50051
      - METRICS_PORT=9100
      - DATA_DIR=/data/ledger
      - BATCHING_ENABLED=true
      - BATCH_SIZE=100
      - BATCH_TIMEOUT_MS=10
      - LOG_LEVEL=info
    volumes:
      - ledger-1-data:/data/ledger
      - ledger-1-logs:/var/log/deltran
    networks:
      - deltran-network
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:50051"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G

  ledger-2:
    build:
      context: ./ledger-core
      dockerfile: Dockerfile
    container_name: deltran-ledger-2
    restart: always
    ports:
      - "50052:50051"
      - "9101:9100"
    environment:
      - LEDGER_ID=ledger-2
      - GRPC_PORT=50051
      - METRICS_PORT=9100
      - DATA_DIR=/data/ledger
      - BATCHING_ENABLED=true
      - BATCH_SIZE=100
      - BATCH_TIMEOUT_MS=10
      - LOG_LEVEL=info
    volumes:
      - ledger-2-data:/data/ledger
      - ledger-2-logs:/var/log/deltran
    networks:
      - deltran-network
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:50051"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G

  ledger-3:
    build:
      context: ./ledger-core
      dockerfile: Dockerfile
    container_name: deltran-ledger-3
    restart: always
    ports:
      - "50053:50051"
      - "9102:9100"
    environment:
      - LEDGER_ID=ledger-3
      - GRPC_PORT=50051
      - METRICS_PORT=9100
      - DATA_DIR=/data/ledger
      - BATCHING_ENABLED=true
      - BATCH_SIZE=100
      - BATCH_TIMEOUT_MS=10
      - LOG_LEVEL=info
    volumes:
      - ledger-3-data:/data/ledger
      - ledger-3-logs:/var/log/deltran
    networks:
      - deltran-network
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:50051"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G

  # ============================================================================
  # Settlement Engine
  # ============================================================================

  settlement:
    build:
      context: ./settlement
      dockerfile: Dockerfile
    container_name: deltran-settlement
    restart: always
    ports:
      - "50060:50060"  # gRPC
      - "9110:9110"    # Metrics
    environment:
      - SETTLEMENT_ID=settlement-1
      - GRPC_PORT=50060
      - METRICS_PORT=9110
      - LEDGER_GRPC_ADDR=ledger-1:50051
      - WINDOW_DURATION_HOURS=6
      - NETTING_ENABLED=true
      - ISO20022_ENABLED=true
      - LOG_LEVEL=info
    volumes:
      - settlement-data:/data/settlement
      - settlement-logs:/var/log/deltran
      - ./settlement/templates:/templates:ro
    networks:
      - deltran-network
    depends_on:
      - ledger-1
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:50060"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  # ============================================================================
  # Consensus Validators (7 nodes for BFT)
  # ============================================================================

  consensus-1:
    build:
      context: ./consensus
      dockerfile: Dockerfile
    container_name: deltran-consensus-1
    restart: always
    ports:
      - "26657:26657"  # RPC
      - "26656:26656"  # P2P
      - "9120:9120"    # Metrics
    environment:
      - CONSENSUS_NODE_ID=node-1
      - CONSENSUS_CHAIN_ID=deltran-prod-1
      - CONSENSUS_RPC_ADDR=tcp://0.0.0.0:26657
      - CONSENSUS_P2P_ADDR=tcp://0.0.0.0:26656
      - METRICS_PORT=9120
      - LEDGER_GRPC_ADDR=ledger-1:50051
      - VALIDATOR_POWER=10
      - LOG_LEVEL=info
    volumes:
      - consensus-1-data:/data/consensus
      - consensus-1-cometbft:/data/cometbft
      - ./certs:/certs:ro
    networks:
      - deltran-network
    depends_on:
      - ledger-1
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  consensus-2:
    build:
      context: ./consensus
      dockerfile: Dockerfile
    container_name: deltran-consensus-2
    restart: always
    ports:
      - "26667:26657"
      - "26666:26656"
      - "9121:9120"
    environment:
      - CONSENSUS_NODE_ID=node-2
      - CONSENSUS_CHAIN_ID=deltran-prod-1
      - CONSENSUS_RPC_ADDR=tcp://0.0.0.0:26657
      - CONSENSUS_P2P_ADDR=tcp://0.0.0.0:26656
      - METRICS_PORT=9120
      - LEDGER_GRPC_ADDR=ledger-2:50052
      - VALIDATOR_POWER=10
      - PERSISTENT_PEERS=consensus-1:26656
      - LOG_LEVEL=info
    volumes:
      - consensus-2-data:/data/consensus
      - consensus-2-cometbft:/data/cometbft
    networks:
      - deltran-network
    depends_on:
      - consensus-1
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  consensus-3:
    build:
      context: ./consensus
      dockerfile: Dockerfile
    container_name: deltran-consensus-3
    restart: always
    ports:
      - "26677:26657"
      - "26676:26656"
      - "9122:9120"
    environment:
      - CONSENSUS_NODE_ID=node-3
      - CONSENSUS_CHAIN_ID=deltran-prod-1
      - CONSENSUS_RPC_ADDR=tcp://0.0.0.0:26657
      - CONSENSUS_P2P_ADDR=tcp://0.0.0.0:26656
      - METRICS_PORT=9120
      - LEDGER_GRPC_ADDR=ledger-3:50053
      - VALIDATOR_POWER=10
      - PERSISTENT_PEERS=consensus-1:26656,consensus-2:26656
      - LOG_LEVEL=info
    volumes:
      - consensus-3-data:/data/consensus
      - consensus-3-cometbft:/data/cometbft
    networks:
      - deltran-network
    depends_on:
      - consensus-1
      - consensus-2
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  # Additional validators (4-7) for full BFT
  # Configure similarly to consensus-1,2,3

  # ============================================================================
  # Load Balancer (nginx)
  # ============================================================================

  load-balancer:
    image: nginx:1.25-alpine
    container_name: deltran-lb
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/certs:ro
      - nginx-logs:/var/log/nginx
    networks:
      - deltran-network
    depends_on:
      - gateway-1
      - gateway-2
      - gateway-3
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================================================
  # Monitoring Stack
  # ============================================================================

  prometheus:
    image: prom/prometheus:latest
    container_name: deltran-prometheus
    restart: always
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
    networks:
      - deltran-network

  grafana:
    image: grafana/grafana:latest
    container_name: deltran-grafana
    restart: always
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - grafana-data:/var/lib/grafana
    networks:
      - deltran-network
    depends_on:
      - prometheus

  loki:
    image: grafana/loki:latest
    container_name: deltran-loki
    restart: always
    ports:
      - "3100:3100"
    volumes:
      - ./monitoring/loki.yml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki
    networks:
      - deltran-network

  promtail:
    image: grafana/promtail:latest
    container_name: deltran-promtail
    restart: always
    volumes:
      - ./monitoring/promtail.yml:/etc/promtail/config.yml:ro
      - /var/log:/var/log:ro
      - gateway-1-logs:/var/log/deltran/gateway-1:ro
      - gateway-2-logs:/var/log/deltran/gateway-2:ro
      - gateway-3-logs:/var/log/deltran/gateway-3:ro
      - ledger-1-logs:/var/log/deltran/ledger-1:ro
      - ledger-2-logs:/var/log/deltran/ledger-2:ro
      - ledger-3-logs:/var/log/deltran/ledger-3:ro
    networks:
      - deltran-network
    depends_on:
      - loki

  # ============================================================================
  # Backup Service
  # ============================================================================

  backup:
    image: postgres:16-alpine
    container_name: deltran-backup
    restart: always
    environment:
      - BACKUP_SCHEDULE=0 2 * * *  # Daily at 2 AM
      - S3_BUCKET=deltran-backups
      - AWS_REGION=us-east-1
    volumes:
      - ./scripts/backup.sh:/backup.sh:ro
      - ledger-1-data:/data/ledger-1:ro
      - ledger-2-data:/data/ledger-2:ro
      - ledger-3-data:/data/ledger-3:ro
    networks:
      - deltran-network
    command: ["/bin/sh", "-c", "while true; do /backup.sh; sleep 86400; done"]

networks:
  deltran-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  # Gateway
  gateway-1-logs:
  gateway-2-logs:
  gateway-3-logs:

  # Ledger
  ledger-1-data:
  ledger-2-data:
  ledger-3-data:
  ledger-1-logs:
  ledger-2-logs:
  ledger-3-logs:

  # Settlement
  settlement-data:
  settlement-logs:

  # Consensus
  consensus-1-data:
  consensus-2-data:
  consensus-3-data:
  consensus-1-cometbft:
  consensus-2-cometbft:
  consensus-3-cometbft:

  # Monitoring
  prometheus-data:
  grafana-data:
  loki-data:

  # Nginx
  nginx-logs: