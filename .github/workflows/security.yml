name: Security Checks

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # Secrets Scanning with Gitleaks
  # ============================================================================
  secrets-scan:
    name: Secrets Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for gitleaks

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Upload Gitleaks report
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: gitleaks-report
          path: gitleaks-report.json

  # ============================================================================
  # SBOM Generation with CycloneDX
  # ============================================================================
  sbom-generation:
    name: SBOM Generation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install cargo-cyclonedx
        run: cargo install cargo-cyclonedx

      - name: Generate SBOM for protocol-core
        run: |
          cd protocol-core
          cargo cyclonedx --format json --output-cdx sbom-protocol-core.json

      - name: Generate SBOM for adapters
        run: |
          cd adapters
          cargo cyclonedx --format json --output-cdx sbom-adapters.json

      - name: Generate SBOM for message-bus
        run: |
          cd message-bus
          cargo cyclonedx --format json --output-cdx sbom-message-bus.json

      - name: Generate SBOM for ledger-core
        run: |
          cd ledger-core
          cargo cyclonedx --format json --output-cdx sbom-ledger-core.json

      - name: Generate SBOM for settlement
        run: |
          cd settlement
          cargo cyclonedx --format json --output-cdx sbom-settlement.json

      - name: Upload SBOMs
        uses: actions/upload-artifact@v3
        with:
          name: sboms
          path: |
            protocol-core/sbom-*.json
            adapters/sbom-*.json
            message-bus/sbom-*.json
            ledger-core/sbom-*.json
            settlement/sbom-*.json
          retention-days: 90

      - name: Verify SBOM integrity
        run: |
          for sbom in */sbom-*.json; do
            echo "Validating $sbom"
            jq empty "$sbom" || exit 1
          done

  # ============================================================================
  # Dependency Audit
  # ============================================================================
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run cargo audit
        run: cargo audit --json > audit-report.json

      - name: Check for vulnerabilities
        run: |
          VULN_COUNT=$(jq '.vulnerabilities.count' audit-report.json)
          echo "Found $VULN_COUNT vulnerabilities"
          if [ "$VULN_COUNT" -gt 0 ]; then
            jq '.vulnerabilities.list' audit-report.json
            exit 1
          fi

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: audit-report
          path: audit-report.json

  # ============================================================================
  # Fuzzing (on schedule only to save CI time)
  # ============================================================================
  fuzzing:
    name: Fuzzing Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: nightly

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Run canonical_serialization fuzz test
        run: |
          cd protocol-core
          timeout 300 cargo +nightly fuzz run canonical_serialization || true

      - name: Run merkle_tree fuzz test
        run: |
          cd protocol-core
          timeout 300 cargo +nightly fuzz run merkle_tree || true

      - name: Run money_arithmetic fuzz test
        run: |
          cd protocol-core
          timeout 300 cargo +nightly fuzz run money_arithmetic || true

      - name: Check for crashes
        run: |
          cd protocol-core
          if [ -d fuzz/artifacts ]; then
            echo "❌ Fuzzing found crashes!"
            ls -la fuzz/artifacts/
            exit 1
          else
            echo "✅ No crashes found"
          fi

  # ============================================================================
  # Property-Based Tests
  # ============================================================================
  property-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Run property tests
        run: |
          cd protocol-core
          cargo test --test property_tests --release -- --nocapture

      - name: Run property tests with more cases
        if: github.event_name == 'schedule'
        run: |
          cd protocol-core
          PROPTEST_CASES=10000 cargo test --test property_tests --release

  # ============================================================================
  # Static Analysis
  # ============================================================================
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: clippy

      - name: Run clippy (deny warnings)
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Check for unsafe code
        run: |
          echo "Checking for unsafe code blocks..."
          if grep -r "unsafe " --include="*.rs" protocol-core/src adapters/src message-bus/src ledger-core/src settlement/src; then
            echo "❌ Found unsafe code!"
            exit 1
          else
            echo "✅ No unsafe code found"
          fi

  # ============================================================================
  # License Compliance
  # ============================================================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install cargo-license
        run: cargo install cargo-license

      - name: Check licenses
        run: |
          cargo license --json > licenses.json
          cat licenses.json | jq '.'

      - name: Verify approved licenses
        run: |
          # Check for GPL licenses (not compatible with Apache-2.0)
          if cargo license --json | jq -r '.[].license' | grep -iE 'GPL|AGPL'; then
            echo "❌ Found GPL-licensed dependencies!"
            exit 1
          else
            echo "✅ All licenses are compatible"
          fi

      - name: Upload license report
        uses: actions/upload-artifact@v3
        with:
          name: licenses
          path: licenses.json
