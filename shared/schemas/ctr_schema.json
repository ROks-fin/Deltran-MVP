{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://deltran.rail/schemas/ctr/v1.0.0",
  "title": "Cross-border Transaction Record (CTR)",
  "description": "Canonical schema for rail payment transactions with regulatory compliance",
  "type": "object",
  "required": [
    "transaction_id",
    "uetr",
    "timestamp",
    "amount",
    "currency",
    "debtor_party",
    "creditor_party",
    "settlement_method",
    "payment_purpose",
    "regulatory_reporting"
  ],
  "properties": {
    "transaction_id": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
      "description": "UUIDv7 transaction identifier"
    },
    "uetr": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
      "description": "Unique End-to-end Transaction Reference (ISO 20022)"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "Transaction initiation timestamp (ISO 8601)"
    },
    "amount": {
      "type": "object",
      "required": ["value", "currency"],
      "properties": {
        "value": {
          "type": "string",
          "pattern": "^[0-9]+\\.[0-9]{2}$",
          "description": "Monetary amount with exactly 2 decimal places"
        },
        "currency": {
          "type": "string",
          "pattern": "^[A-Z]{3}$",
          "description": "ISO 4217 currency code"
        }
      }
    },
    "debtor_party": {
      "type": "object",
      "required": ["name", "account", "agent"],
      "properties": {
        "name": {
          "type": "string",
          "maxLength": 140,
          "description": "Debtor party name (Travel Rule compliant)"
        },
        "account": {
          "type": "object",
          "required": ["iban"],
          "properties": {
            "iban": {
              "type": "string",
              "pattern": "^[A-Z]{2}[0-9]{2}[A-Z0-9]{1,30}$",
              "description": "International Bank Account Number"
            },
            "account_type": {
              "type": "string",
              "enum": ["CHECKING", "SAVINGS", "CORPORATE", "NOSTRO", "VOSTRO"]
            }
          }
        },
        "agent": {
          "type": "object",
          "required": ["bic"],
          "properties": {
            "bic": {
              "type": "string",
              "pattern": "^[A-Z]{4}[A-Z]{2}[A-Z0-9]{2}([A-Z0-9]{3})?$",
              "description": "Bank Identifier Code (SWIFT)"
            },
            "name": {
              "type": "string",
              "maxLength": 140
            },
            "clearing_system_id": {
              "type": "string",
              "maxLength": 35
            }
          }
        },
        "address": {
          "$ref": "#/definitions/address"
        },
        "identification": {
          "type": "object",
          "properties": {
            "organization_id": {
              "type": "string",
              "maxLength": 35,
              "description": "Legal entity identifier"
            },
            "private_id": {
              "type": "string",
              "maxLength": 35,
              "description": "Private person identifier (masked in logs)"
            }
          }
        }
      }
    },
    "creditor_party": {
      "type": "object",
      "required": ["name", "account", "agent"],
      "properties": {
        "name": {
          "type": "string",
          "maxLength": 140,
          "description": "Creditor party name (Travel Rule compliant)"
        },
        "account": {
          "type": "object",
          "required": ["iban"],
          "properties": {
            "iban": {
              "type": "string",
              "pattern": "^[A-Z]{2}[0-9]{2}[A-Z0-9]{1,30}$",
              "description": "International Bank Account Number"
            },
            "account_type": {
              "type": "string",
              "enum": ["CHECKING", "SAVINGS", "CORPORATE", "NOSTRO", "VOSTRO"]
            }
          }
        },
        "agent": {
          "type": "object",
          "required": ["bic"],
          "properties": {
            "bic": {
              "type": "string",
              "pattern": "^[A-Z]{4}[A-Z]{2}[A-Z0-9]{2}([A-Z0-9]{3})?$",
              "description": "Bank Identifier Code (SWIFT)"
            },
            "name": {
              "type": "string",
              "maxLength": 140
            },
            "clearing_system_id": {
              "type": "string",
              "maxLength": 35
            }
          }
        },
        "address": {
          "$ref": "#/definitions/address"
        },
        "identification": {
          "type": "object",
          "properties": {
            "organization_id": {
              "type": "string",
              "maxLength": 35,
              "description": "Legal entity identifier"
            },
            "private_id": {
              "type": "string",
              "maxLength": 35,
              "description": "Private person identifier (masked in logs)"
            }
          }
        }
      }
    },
    "settlement_method": {
      "type": "string",
      "enum": ["INSTANT", "PVP", "NETTING", "CORRESPONDENT"],
      "description": "Settlement method used"
    },
    "payment_purpose": {
      "type": "object",
      "required": ["category"],
      "properties": {
        "category": {
          "type": "string",
          "enum": [
            "TRADE", "SERVICES", "INVESTMENT", "PERSONAL",
            "GOVERNMENT", "CHARITY", "PENSION", "TAX"
          ]
        },
        "subcategory": {
          "type": "string",
          "maxLength": 35
        },
        "description": {
          "type": "string",
          "maxLength": 140
        }
      }
    },
    "regulatory_reporting": {
      "type": "object",
      "required": ["travel_rule", "screening"],
      "properties": {
        "travel_rule": {
          "type": "object",
          "required": ["threshold_met", "fields_complete"],
          "properties": {
            "threshold_met": {
              "type": "boolean",
              "description": "Whether transaction exceeds Travel Rule threshold"
            },
            "threshold_amount": {
              "type": "string",
              "pattern": "^[0-9]+\\.[0-9]{2}$"
            },
            "fields_complete": {
              "type": "boolean",
              "description": "Whether all required Travel Rule fields are present"
            },
            "originator_info": {
              "type": "object",
              "properties": {
                "name": {"type": "string", "maxLength": 140},
                "account": {"type": "string", "maxLength": 34},
                "address": {"$ref": "#/definitions/address"},
                "id_number": {"type": "string", "maxLength": 35}
              }
            },
            "beneficiary_info": {
              "type": "object",
              "properties": {
                "name": {"type": "string", "maxLength": 140},
                "account": {"type": "string", "maxLength": 34},
                "address": {"$ref": "#/definitions/address"},
                "id_number": {"type": "string", "maxLength": 35}
              }
            }
          }
        },
        "screening": {
          "type": "object",
          "required": ["sanctions_check", "pep_check"],
          "properties": {
            "sanctions_check": {
              "type": "object",
              "required": ["status", "timestamp"],
              "properties": {
                "status": {
                  "type": "string",
                  "enum": ["PASS", "FAIL", "REVIEW"]
                },
                "timestamp": {
                  "type": "string",
                  "format": "date-time"
                },
                "lists_checked": {
                  "type": "array",
                  "items": {
                    "type": "string",
                    "enum": ["OFAC", "UN", "EU", "HMT", "CONSOLIDATED"]
                  }
                },
                "matches": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "list": {"type": "string"},
                      "match_score": {"type": "number", "minimum": 0, "maximum": 1},
                      "entity_id": {"type": "string"}
                    }
                  }
                }
              }
            },
            "pep_check": {
              "type": "object",
              "required": ["status", "timestamp"],
              "properties": {
                "status": {
                  "type": "string",
                  "enum": ["PASS", "FAIL", "REVIEW"]
                },
                "timestamp": {
                  "type": "string",
                  "format": "date-time"
                },
                "risk_category": {
                  "type": "string",
                  "enum": ["LOW", "MEDIUM", "HIGH"]
                }
              }
            }
          }
        },
        "audit_trail": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["action", "timestamp", "actor"],
            "properties": {
              "action": {"type": "string", "maxLength": 50},
              "timestamp": {"type": "string", "format": "date-time"},
              "actor": {"type": "string", "maxLength": 100},
              "details": {"type": "object"}
            }
          }
        }
      }
    },
    "risk_assessment": {
      "type": "object",
      "properties": {
        "risk_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "risk_factors": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "HIGH_VALUE", "HIGH_RISK_COUNTRY", "NEW_COUNTERPARTY",
              "UNUSUAL_PATTERN", "SANCTIONS_PROXIMITY", "PEP_INVOLVEMENT"
            ]
          }
        },
        "risk_mitigation": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["ENHANCED_SCREENING", "MANUAL_REVIEW", "ADDITIONAL_DOCS"]
          }
        }
      }
    },
    "settlement_details": {
      "type": "object",
      "properties": {
        "settlement_date": {
          "type": "string",
          "format": "date"
        },
        "settlement_currency": {
          "type": "string",
          "pattern": "^[A-Z]{3}$"
        },
        "exchange_rate": {
          "type": "number",
          "minimum": 0,
          "exclusiveMinimum": true
        },
        "charges": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["type", "amount", "currency"],
            "properties": {
              "type": {
                "type": "string",
                "enum": ["CORRESPONDENT", "INTERMEDIARY", "BENEFICIARY", "REGULATORY"]
              },
              "amount": {
                "type": "string",
                "pattern": "^[0-9]+\\.[0-9]{2}$"
              },
              "currency": {
                "type": "string",
                "pattern": "^[A-Z]{3}$"
              }
            }
          }
        },
        "netting_batch_id": {
          "type": "string",
          "description": "Batch identifier if settled via netting"
        }
      }
    },
    "status": {
      "type": "string",
      "enum": [
        "INITIATED", "VALIDATED", "SCREENED", "APPROVED", "REJECTED",
        "SETTLED", "COMPLETED", "FAILED", "CANCELLED"
      ],
      "description": "Transaction processing status"
    },
    "status_history": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["status", "timestamp"],
        "properties": {
          "status": {
            "type": "string",
            "enum": [
              "INITIATED", "VALIDATED", "SCREENED", "APPROVED", "REJECTED",
              "SETTLED", "COMPLETED", "FAILED", "CANCELLED"
            ]
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "reason": {
            "type": "string",
            "maxLength": 255
          }
        }
      }
    },
    "ledger_proof": {
      "type": "object",
      "properties": {
        "block_hash": {
          "type": "string",
          "pattern": "^[0-9a-f]{64}$"
        },
        "block_number": {
          "type": "integer",
          "minimum": 0
        },
        "transaction_index": {
          "type": "integer",
          "minimum": 0
        },
        "merkle_proof": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[0-9a-f]{64}$"
          }
        },
        "validator_signatures": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["validator", "signature"],
            "properties": {
              "validator": {"type": "string"},
              "signature": {"type": "string", "pattern": "^[0-9a-f]{128}$"}
            }
          }
        }
      }
    }
  },
  "definitions": {
    "address": {
      "type": "object",
      "properties": {
        "street_name": {"type": "string", "maxLength": 70},
        "building_number": {"type": "string", "maxLength": 16},
        "post_code": {"type": "string", "maxLength": 16},
        "town_name": {"type": "string", "maxLength": 35},
        "country_subdivision": {"type": "string", "maxLength": 35},
        "country": {"type": "string", "pattern": "^[A-Z]{2}$"}
      }
    }
  }
}