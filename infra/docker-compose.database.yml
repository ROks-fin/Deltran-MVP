version: '3.8'

services:
  # PostgreSQL Primary
  postgres-primary:
    image: postgres:15-alpine
    container_name: deltran-postgres-primary
    environment:
      POSTGRES_DB: deltran
      POSTGRES_USER: deltran_app
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme123}
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: ${REPLICATION_PASSWORD:-replica456}
    command:
      - postgres
      - -c
      - max_connections=200
      - -c
      - shared_buffers=256MB
      - -c
      - effective_cache_size=1GB
      - -c
      - maintenance_work_mem=64MB
      - -c
      - checkpoint_completion_target=0.9
      - -c
      - wal_level=replica
      - -c
      - max_wal_senders=3
      - -c
      - max_replication_slots=3
      - -c
      - hot_standby=on
      - -c
      - log_statement=mod
      - -c
      - log_min_duration_statement=1000
    volumes:
      - postgres-primary-data:/var/lib/postgresql/data
      - ./sql:/docker-entrypoint-initdb.d
      - postgres-logs:/var/log/postgresql
    ports:
      - "5432:5432"
    networks:
      - deltran-db-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U deltran_app -d deltran"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Replica 1
  postgres-replica1:
    image: postgres:15-alpine
    container_name: deltran-postgres-replica1
    environment:
      PGUSER: replicator
      PGPASSWORD: ${REPLICATION_PASSWORD:-replica456}
    command: |
      bash -c "
      until pg_basebackup --pgdata=/var/lib/postgresql/data -R --slot=replication_slot_1 --host=postgres-primary --port=5432
      do
        echo 'Waiting for primary to be available...'
        sleep 1s
      done
      echo 'Backup done, starting replica...'
      chmod 0700 /var/lib/postgresql/data
      postgres
      "
    volumes:
      - postgres-replica1-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      - deltran-db-network
    depends_on:
      postgres-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U replicator"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Replica 2
  postgres-replica2:
    image: postgres:15-alpine
    container_name: deltran-postgres-replica2
    environment:
      PGUSER: replicator
      PGPASSWORD: ${REPLICATION_PASSWORD:-replica456}
    command: |
      bash -c "
      until pg_basebackup --pgdata=/var/lib/postgresql/data -R --slot=replication_slot_2 --host=postgres-primary --port=5432
      do
        echo 'Waiting for primary to be available...'
        sleep 1s
      done
      echo 'Backup done, starting replica...'
      chmod 0700 /var/lib/postgresql/data
      postgres
      "
    volumes:
      - postgres-replica2-data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    networks:
      - deltran-db-network
    depends_on:
      postgres-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U replicator"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PgBouncer - Connection Pooling
  pgbouncer:
    image: edoburu/pgbouncer:latest
    container_name: deltran-pgbouncer
    environment:
      DATABASE_URL: "postgres://deltran_app:${POSTGRES_PASSWORD:-changeme123}@postgres-primary:5432/deltran"
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 1000
      DEFAULT_POOL_SIZE: 25
      MIN_POOL_SIZE: 10
      RESERVE_POOL_SIZE: 5
      RESERVE_POOL_TIMEOUT: 3
      MAX_DB_CONNECTIONS: 50
      MAX_USER_CONNECTIONS: 50
      SERVER_IDLE_TIMEOUT: 600
      SERVER_LIFETIME: 3600
      SERVER_CONNECT_TIMEOUT: 15
      QUERY_TIMEOUT: 0
      CLIENT_IDLE_TIMEOUT: 0
      IDLE_TRANSACTION_TIMEOUT: 0
      ADMIN_USERS: deltran_app
      STATS_USERS: deltran_app
    ports:
      - "6432:5432"
    networks:
      - deltran-db-network
    depends_on:
      postgres-primary:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "5432"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Admin UI (pgAdmin)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: deltran-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@deltran.local
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin123}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - "5050:80"
    networks:
      - deltran-db-network
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    depends_on:
      - postgres-primary

volumes:
  postgres-primary-data:
    driver: local
  postgres-replica1-data:
    driver: local
  postgres-replica2-data:
    driver: local
  postgres-logs:
    driver: local
  pgadmin-data:
    driver: local

networks:
  deltran-db-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
