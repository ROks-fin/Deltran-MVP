version: '3.8'

services:
  # Redis Master
  redis-master:
    image: redis:7-alpine
    container_name: deltran-redis-master
    command: >
      redis-server
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --appendonly yes
      --appendfsync everysec
      --requirepass ${REDIS_PASSWORD:-redis123}
      --masterauth ${REDIS_PASSWORD:-redis123}
    ports:
      - "6379:6379"
    volumes:
      - redis-master-data:/data
    networks:
      - deltran-cache-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Redis Replica 1
  redis-replica1:
    image: redis:7-alpine
    container_name: deltran-redis-replica1
    command: >
      redis-server
      --replicaof redis-master 6379
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --appendonly yes
      --appendfsync everysec
      --requirepass ${REDIS_PASSWORD:-redis123}
      --masterauth ${REDIS_PASSWORD:-redis123}
    ports:
      - "6380:6379"
    volumes:
      - redis-replica1-data:/data
    networks:
      - deltran-cache-network
    depends_on:
      redis-master:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Redis Replica 2
  redis-replica2:
    image: redis:7-alpine
    container_name: deltran-redis-replica2
    command: >
      redis-server
      --replicaof redis-master 6379
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --appendonly yes
      --appendfsync everysec
      --requirepass ${REDIS_PASSWORD:-redis123}
      --masterauth ${REDIS_PASSWORD:-redis123}
    ports:
      - "6381:6379"
    volumes:
      - redis-replica2-data:/data
    networks:
      - deltran-cache-network
    depends_on:
      redis-master:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Redis Sentinel 1
  redis-sentinel1:
    image: redis:7-alpine
    container_name: deltran-redis-sentinel1
    command: >
      sh -c "
      echo 'port 26379' > /tmp/sentinel.conf &&
      echo 'dir /tmp' >> /tmp/sentinel.conf &&
      echo 'sentinel monitor deltran-master redis-master 6379 2' >> /tmp/sentinel.conf &&
      echo 'sentinel auth-pass deltran-master ${REDIS_PASSWORD:-redis123}' >> /tmp/sentinel.conf &&
      echo 'sentinel down-after-milliseconds deltran-master 5000' >> /tmp/sentinel.conf &&
      echo 'sentinel parallel-syncs deltran-master 1' >> /tmp/sentinel.conf &&
      echo 'sentinel failover-timeout deltran-master 10000' >> /tmp/sentinel.conf &&
      redis-server /tmp/sentinel.conf --sentinel
      "
    ports:
      - "26379:26379"
    networks:
      - deltran-cache-network
    depends_on:
      - redis-master
      - redis-replica1
      - redis-replica2

  # Redis Sentinel 2
  redis-sentinel2:
    image: redis:7-alpine
    container_name: deltran-redis-sentinel2
    command: >
      sh -c "
      echo 'port 26379' > /tmp/sentinel.conf &&
      echo 'dir /tmp' >> /tmp/sentinel.conf &&
      echo 'sentinel monitor deltran-master redis-master 6379 2' >> /tmp/sentinel.conf &&
      echo 'sentinel auth-pass deltran-master ${REDIS_PASSWORD:-redis123}' >> /tmp/sentinel.conf &&
      echo 'sentinel down-after-milliseconds deltran-master 5000' >> /tmp/sentinel.conf &&
      echo 'sentinel parallel-syncs deltran-master 1' >> /tmp/sentinel.conf &&
      echo 'sentinel failover-timeout deltran-master 10000' >> /tmp/sentinel.conf &&
      redis-server /tmp/sentinel.conf --sentinel
      "
    ports:
      - "26380:26379"
    networks:
      - deltran-cache-network
    depends_on:
      - redis-master
      - redis-replica1
      - redis-replica2

  # Redis Sentinel 3
  redis-sentinel3:
    image: redis:7-alpine
    container_name: deltran-redis-sentinel3
    command: >
      sh -c "
      echo 'port 26379' > /tmp/sentinel.conf &&
      echo 'dir /tmp' >> /tmp/sentinel.conf &&
      echo 'sentinel monitor deltran-master redis-master 6379 2' >> /tmp/sentinel.conf &&
      echo 'sentinel auth-pass deltran-master ${REDIS_PASSWORD:-redis123}' >> /tmp/sentinel.conf &&
      echo 'sentinel down-after-milliseconds deltran-master 5000' >> /tmp/sentinel.conf &&
      echo 'sentinel parallel-syncs deltran-master 1' >> /tmp/sentinel.conf &&
      echo 'sentinel failover-timeout deltran-master 10000' >> /tmp/sentinel.conf &&
      redis-server /tmp/sentinel.conf --sentinel
      "
    ports:
      - "26381:26379"
    networks:
      - deltran-cache-network
    depends_on:
      - redis-master
      - redis-replica1
      - redis-replica2

  # Redis Commander - Web UI
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: deltran-redis-commander
    environment:
      - REDIS_HOSTS=master:redis-master:6379:0:${REDIS_PASSWORD:-redis123},replica1:redis-replica1:6379:0:${REDIS_PASSWORD:-redis123},replica2:redis-replica2:6379:0:${REDIS_PASSWORD:-redis123}
    ports:
      - "8081:8081"
    networks:
      - deltran-cache-network
    depends_on:
      - redis-master

volumes:
  redis-master-data:
    driver: local
  redis-replica1-data:
    driver: local
  redis-replica2-data:
    driver: local

networks:
  deltran-cache-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
