# Envoy Proxy Configuration for DelTran MVP
# Version: 1.0
# Description: Edge proxy with mTLS, rate limiting, and circuit breakers

admin:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901

static_resources:
  listeners:
  # Main HTTPS listener
  - name: https_listener
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 8443
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_https
          codec_type: AUTO

          # Routing
          route_config:
            name: local_route
            virtual_hosts:
            - name: deltran_backend
              domains: ["*"]
              routes:
              # Token Engine routes (direct to service)
              - match:
                  prefix: "/api/v1/tokens/"
                route:
                  cluster: token_engine_cluster
                  timeout: 30s
                  retry_policy:
                    retry_on: "5xx,reset,connect-failure,refused-stream"
                    num_retries: 3
                    per_try_timeout: 10s

              # Settlement Engine routes (direct to service)
              - match:
                  prefix: "/api/v1/accounts/"
                route:
                  cluster: settlement_engine_cluster
                  timeout: 30s
                  retry_policy:
                    retry_on: "5xx,reset,connect-failure,refused-stream"
                    num_retries: 3
                    per_try_timeout: 10s

              # Reporting Engine routes (direct to service)
              - match:
                  prefix: "/api/v1/reports/"
                route:
                  cluster: reporting_engine_cluster
                  timeout: 60s
                  retry_policy:
                    retry_on: "5xx,reset,connect-failure,refused-stream"
                    num_retries: 2
                    per_try_timeout: 30s

              # Notification Engine routes (direct to service)
              - match:
                  prefix: "/api/v1/notifications/"
                route:
                  cluster: notification_engine_cluster
                  timeout: 30s

              # Clearing Engine routes (direct to service)
              - match:
                  prefix: "/api/v1/clearing/"
                route:
                  cluster: clearing_engine_cluster
                  timeout: 30s

              # Compliance Engine routes (direct to service)
              - match:
                  prefix: "/api/v1/compliance/"
                route:
                  cluster: compliance_engine_cluster
                  timeout: 30s

              # Risk Engine routes (direct to service)
              - match:
                  prefix: "/api/v1/risk/"
                route:
                  cluster: risk_engine_cluster
                  timeout: 15s

              # Liquidity Router routes (direct to service)
              - match:
                  prefix: "/api/v1/liquidity/"
                route:
                  cluster: liquidity_router_cluster
                  timeout: 30s

              # Obligation Engine routes (direct to service)
              - match:
                  prefix: "/api/v1/obligations/"
                route:
                  cluster: obligation_engine_cluster
                  timeout: 30s

              # Gateway routes (for auth, transfers, etc.)
              - match:
                  prefix: "/api/v1/"
                route:
                  cluster: gateway_cluster
                  timeout: 30s
                  retry_policy:
                    retry_on: "5xx,reset,connect-failure,refused-stream"
                    num_retries: 3
                    per_try_timeout: 10s
                    retry_host_predicate:
                    - name: envoy.retry_host_predicates.previous_hosts
                    host_selection_retry_max_attempts: 3
                typed_per_filter_config:
                  envoy.filters.http.local_ratelimit:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                    stat_prefix: api_rate_limit
                    token_bucket:
                      max_tokens: 1000
                      tokens_per_fill: 1000
                      fill_interval: 60s
                    filter_enabled:
                      runtime_key: local_rate_limit_enabled
                      default_value:
                        numerator: 100
                        denominator: HUNDRED
                    filter_enforced:
                      runtime_key: local_rate_limit_enforced
                      default_value:
                        numerator: 100
                        denominator: HUNDRED
                    response_headers_to_add:
                    - header:
                        key: x-rate-limit-status
                        value: "%RESPONSE_CODE%"

              # Health check endpoint
              - match:
                  prefix: "/health"
                route:
                  cluster: gateway_cluster
                  timeout: 5s

              # WebSocket endpoint for notifications
              - match:
                  prefix: "/ws"
                route:
                  cluster: notification_engine_cluster
                  timeout: 0s  # No timeout for WebSocket
                  upgrade_configs:
                  - upgrade_type: websocket

              # Metrics endpoint
              - match:
                  prefix: "/metrics"
                route:
                  cluster: prometheus_cluster
                  timeout: 10s

              # Admin panel (restricted)
              - match:
                  prefix: "/admin"
                route:
                  cluster: gateway_cluster
                  timeout: 30s
                typed_per_filter_config:
                  envoy.filters.http.local_ratelimit:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                    stat_prefix: admin_rate_limit
                    token_bucket:
                      max_tokens: 100
                      tokens_per_fill: 100
                      fill_interval: 60s

          # HTTP filters
          http_filters:
          # Rate limiting filter
          - name: envoy.filters.http.local_ratelimit
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
              stat_prefix: http_local_rate_limiter
              token_bucket:
                max_tokens: 10000
                tokens_per_fill: 10000
                fill_interval: 60s
              filter_enabled:
                runtime_key: local_rate_limit_enabled
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              filter_enforced:
                runtime_key: local_rate_limit_enforced
                default_value:
                  numerator: 100
                  denominator: HUNDRED

          # CORS filter
          - name: envoy.filters.http.cors
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors

          # RBAC filter for authorization
          - name: envoy.filters.http.rbac
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.rbac.v3.RBAC
              rules:
                action: ALLOW
                policies:
                  "allow-all":
                    permissions:
                    - any: true
                    principals:
                    - any: true

          # Router filter (must be last)
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

          # Access logging
          access_log:
          - name: envoy.access_loggers.file
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
              path: /dev/stdout
              format: "[%START_TIME%] \"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \"%REQ(X-FORWARDED-FOR)%\" \"%REQ(USER-AGENT)%\" \"%REQ(X-REQUEST-ID)%\" \"%REQ(:AUTHORITY)%\" \"%UPSTREAM_HOST%\"\n"

      # TLS configuration
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
          common_tls_context:
            tls_certificates:
            - certificate_chain:
                filename: /etc/envoy/certs/server-cert.pem
              private_key:
                filename: /etc/envoy/certs/server-key.pem
            validation_context:
              trusted_ca:
                filename: /etc/envoy/certs/ca-cert.pem
            alpn_protocols:
            - h2
            - http/1.1

  # HTTP redirect listener (80 -> 443)
  - name: http_listener
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 8080
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          codec_type: AUTO
          route_config:
            name: local_route
            virtual_hosts:
            - name: deltran_backend
              domains: ["*"]
              routes:
              # Direct routing to gateway (for MVP - no TLS redirect)
              - match:
                  prefix: "/"
                route:
                  cluster: gateway_cluster
                  timeout: 30s
          http_filters:
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
          access_log:
          - name: envoy.access_loggers.file
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
              path: /dev/stdout

  # Cluster definitions
  clusters:
  # Gateway service cluster
  - name: gateway_cluster
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: gateway_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: gateway
                port_value: 8080

    # Health checks
    health_checks:
    - timeout: 5s
      interval: 10s
      unhealthy_threshold: 3
      healthy_threshold: 2
      http_health_check:
        path: /health
        expected_statuses:
        - start: 200
          end: 299

    # Circuit breaker configuration
    circuit_breakers:
      thresholds:
      - priority: DEFAULT
        max_connections: 1000
        max_pending_requests: 1000
        max_requests: 1000
        max_retries: 3
        track_remaining: true
      - priority: HIGH
        max_connections: 2000
        max_pending_requests: 2000
        max_requests: 2000
        max_retries: 5

    # Outlier detection for automatic host ejection
    outlier_detection:
      consecutive_5xx: 5
      interval: 30s
      base_ejection_time: 30s
      max_ejection_percent: 50
      enforcing_consecutive_5xx: 100
      enforcing_success_rate: 100
      success_rate_minimum_hosts: 3
      success_rate_request_volume: 100
      success_rate_stdev_factor: 1900

    # Connection settings
    connect_timeout: 5s
    per_connection_buffer_limit_bytes: 32768

    # HTTP/2 protocol options
    typed_extension_protocol_options:
      envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
        "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
        explicit_http_config:
          http2_protocol_options:
            max_concurrent_streams: 100
            initial_stream_window_size: 65536
            initial_connection_window_size: 1048576

  # Prometheus cluster for metrics
  - name: prometheus_cluster
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: prometheus_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: prometheus
                port_value: 9090
    connect_timeout: 5s

  # Token Engine cluster
  - name: token_engine_cluster
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: token_engine_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: token-engine
                port_value: 8081
    health_checks:
    - timeout: 5s
      interval: 10s
      unhealthy_threshold: 3
      healthy_threshold: 2
      http_health_check:
        path: /api/v1/tokens/health
    connect_timeout: 5s
    circuit_breakers:
      thresholds:
      - priority: DEFAULT
        max_connections: 500
        max_pending_requests: 500
        max_requests: 500
        max_retries: 3

  # Settlement Engine cluster
  - name: settlement_engine_cluster
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: settlement_engine_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: settlement-engine
                port_value: 8087
    health_checks:
    - timeout: 5s
      interval: 10s
      unhealthy_threshold: 3
      healthy_threshold: 2
      http_health_check:
        path: /health
    connect_timeout: 5s
    circuit_breakers:
      thresholds:
      - priority: DEFAULT
        max_connections: 500
        max_pending_requests: 500
        max_requests: 500
        max_retries: 3

  # Reporting Engine cluster
  - name: reporting_engine_cluster
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: reporting_engine_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: reporting-engine
                port_value: 8088
    health_checks:
    - timeout: 5s
      interval: 10s
      unhealthy_threshold: 3
      healthy_threshold: 2
      http_health_check:
        path: /health
    connect_timeout: 5s
    circuit_breakers:
      thresholds:
      - priority: DEFAULT
        max_connections: 300
        max_pending_requests: 300
        max_requests: 300
        max_retries: 2

  # Obligation Engine cluster
  - name: obligation_engine_cluster
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: obligation_engine_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: obligation-engine
                port_value: 8082
    health_checks:
    - timeout: 5s
      interval: 10s
      unhealthy_threshold: 3
      healthy_threshold: 2
      http_health_check:
        path: /health
    connect_timeout: 5s
    circuit_breakers:
      thresholds:
      - priority: DEFAULT
        max_connections: 500
        max_pending_requests: 500
        max_requests: 500
        max_retries: 3

  # Liquidity Router cluster
  - name: liquidity_router_cluster
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: liquidity_router_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: liquidity-router
                port_value: 8083
    health_checks:
    - timeout: 5s
      interval: 10s
      unhealthy_threshold: 3
      healthy_threshold: 2
      http_health_check:
        path: /health
    connect_timeout: 5s
    circuit_breakers:
      thresholds:
      - priority: DEFAULT
        max_connections: 500
        max_pending_requests: 500
        max_requests: 500
        max_retries: 3

  # Risk Engine cluster
  - name: risk_engine_cluster
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: risk_engine_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: risk-engine
                port_value: 8084
    health_checks:
    - timeout: 5s
      interval: 10s
      unhealthy_threshold: 3
      healthy_threshold: 2
      http_health_check:
        path: /health
    connect_timeout: 5s
    circuit_breakers:
      thresholds:
      - priority: DEFAULT
        max_connections: 500
        max_pending_requests: 500
        max_requests: 500
        max_retries: 3

  # Clearing Engine cluster
  - name: clearing_engine_cluster
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: clearing_engine_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: clearing-engine
                port_value: 8085
    health_checks:
    - timeout: 5s
      interval: 10s
      unhealthy_threshold: 3
      healthy_threshold: 2
      http_health_check:
        path: /health
    connect_timeout: 5s
    circuit_breakers:
      thresholds:
      - priority: DEFAULT
        max_connections: 500
        max_pending_requests: 500
        max_requests: 500
        max_retries: 3

  # Compliance Engine cluster
  - name: compliance_engine_cluster
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: compliance_engine_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: compliance-engine
                port_value: 8086
    health_checks:
    - timeout: 5s
      interval: 10s
      unhealthy_threshold: 3
      healthy_threshold: 2
      http_health_check:
        path: /health
    connect_timeout: 5s
    circuit_breakers:
      thresholds:
      - priority: DEFAULT
        max_connections: 500
        max_pending_requests: 500
        max_requests: 500
        max_retries: 3

  # Notification Engine cluster (updated reference)
  - name: notification_engine_cluster
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: notification_engine_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: notification-engine
                port_value: 8089
    health_checks:
    - timeout: 5s
      interval: 10s
      unhealthy_threshold: 3
      healthy_threshold: 2
      http_health_check:
        path: /health
    connect_timeout: 5s
    circuit_breakers:
      thresholds:
      - priority: DEFAULT
        max_connections: 1000
        max_pending_requests: 1000
        max_requests: 1000
        max_retries: 2

# Layered runtime configuration
layered_runtime:
  layers:
  - name: static_layer_0
    static_layer:
      envoy:
        resource_limits:
          listener:
            https_listener:
              connection_limit: 10000
      overload:
        global_downstream_max_connections: 50000

# Statistics configuration
stats_sinks:
- name: envoy.stat_sinks.statsd
  typed_config:
    "@type": type.googleapis.com/envoy.config.metrics.v3.StatsdSink
    tcp_cluster_name: prometheus_cluster
    prefix: envoy

# Overload management
overload_manager:
  refresh_interval: 0.25s
  resource_monitors:
  - name: "envoy.resource_monitors.fixed_heap"
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.resource_monitors.fixed_heap.v3.FixedHeapConfig
      max_heap_size_bytes: 2147483648  # 2GB

  actions:
  - name: "envoy.overload_actions.shrink_heap"
    triggers:
    - name: "envoy.resource_monitors.fixed_heap"
      threshold:
        value: 0.95
  - name: "envoy.overload_actions.stop_accepting_requests"
    triggers:
    - name: "envoy.resource_monitors.fixed_heap"
      threshold:
        value: 0.98
