syntax = "proto3";

package deltran.compliance.v1;

option go_package = "github.com/deltran/pb/compliance/v1;compliancev1";

import "google/protobuf/timestamp.proto";

// ComplianceService handles sanctions, AML, Travel Rule
service ComplianceService {
  // Screen payment for sanctions/AML
  rpc ScreenPayment(ScreenPaymentRequest) returns (ScreenPaymentResponse);

  // Check Travel Rule requirements
  rpc CheckTravelRule(CheckTravelRuleRequest) returns (CheckTravelRuleResponse);

  // Submit Suspicious Transaction Report (STR)
  rpc SubmitSTR(SubmitSTRRequest) returns (SubmitSTRResponse);

  // Generate regulatory report
  rpc GenerateReport(GenerateReportRequest) returns (GenerateReportResponse);

  // Get compliance statistics
  rpc GetComplianceStats(GetComplianceStatsRequest) returns (GetComplianceStatsResponse);
}

// ScreenPaymentRequest checks sanctions/PEP
message ScreenPaymentRequest {
  string payment_id = 1;
  string amount = 2;
  string currency = 3;

  // Debtor info
  string debtor_name = 4;
  string debtor_account = 5;
  string debtor_country = 6;
  Address debtor_address = 7;

  // Creditor info
  string creditor_name = 8;
  string creditor_account = 9;
  string creditor_country = 10;
  Address creditor_address = 11;

  // Purpose
  string purpose = 12;
}

// ScreenPaymentResponse returns screening result
message ScreenPaymentResponse {
  string screening_id = 1;
  string payment_id = 2;
  ScreeningResult result = 3;
  repeated ScreeningHit hits = 4;
  google.protobuf.Timestamp screened_at = 5;
}

// ScreeningResult outcome
enum ScreeningResult {
  SCREENING_RESULT_UNSPECIFIED = 0;
  SCREENING_RESULT_CLEAR = 1;           // No hits, proceed
  SCREENING_RESULT_HIT = 2;             // Match found, investigate
  SCREENING_RESULT_FALSE_POSITIVE = 3;  // Hit but cleared
  SCREENING_RESULT_BLOCKED = 4;         // Blocked by sanctions
}

// ScreeningHit details
message ScreeningHit {
  string hit_id = 1;
  string list_name = 2; // "OFAC SDN", "UN Consolidated", etc.
  string entity_name = 3;
  float match_score = 4; // 0.0-1.0 confidence
  string match_reason = 5;
  HitType hit_type = 6;
  string country = 7;
}

// HitType categorization
enum HitType {
  HIT_TYPE_UNSPECIFIED = 0;
  HIT_TYPE_SANCTIONS = 1;     // Sanctions list
  HIT_TYPE_PEP = 2;           // Politically Exposed Person
  HIT_TYPE_ADVERSE_MEDIA = 3; // Negative news
  HIT_TYPE_HIGH_RISK = 4;     // High-risk jurisdiction
}

// Address for compliance checks
message Address {
  string address_line_1 = 1;
  string address_line_2 = 2;
  string city = 3;
  string postal_code = 4;
  string country_code = 5; // ISO 3166-1 alpha-2
}

// CheckTravelRuleRequest validates FATF compliance
message CheckTravelRuleRequest {
  string payment_id = 1;
  string amount = 2;
  string currency = 3;

  // Originator (debtor) info
  TravelRuleEntity originator = 4;

  // Beneficiary (creditor) info
  TravelRuleEntity beneficiary = 5;
}

// CheckTravelRuleResponse returns compliance status
message CheckTravelRuleResponse {
  string check_id = 1;
  bool compliant = 2;
  repeated string missing_fields = 3;
  string threshold_applicable = 4; // "USD 1000", "EUR 1000", etc.
  google.protobuf.Timestamp checked_at = 5;
}

// TravelRuleEntity (originator or beneficiary)
message TravelRuleEntity {
  string name = 1;
  string account_number = 2;
  Address address = 3;
  string identification_type = 4; // "passport", "national_id", etc.
  string identification_number = 5;
  string date_of_birth = 6;       // YYYY-MM-DD
  string country_of_birth = 7;
  string nationality = 8;
}

// SubmitSTRRequest files suspicious transaction report
message SubmitSTRRequest {
  string payment_id = 1;
  repeated string related_payment_ids = 2;

  // Reporter info
  string institution_name = 3;
  string reporter_name = 4;
  string reporter_title = 5;

  // Suspicious activity
  string narrative = 6;
  repeated string indicators = 7; // "structuring", "unusual_pattern", etc.
  string amount_involved = 8;
  google.protobuf.Timestamp activity_start_date = 9;
  google.protobuf.Timestamp activity_end_date = 10;

  // Filing info
  string filing_institution_reference = 11;
  google.protobuf.Timestamp filing_date = 12;
}

// SubmitSTRResponse confirms submission
message SubmitSTRResponse {
  string str_id = 1;
  string filing_reference = 2;
  STRStatus status = 3;
  google.protobuf.Timestamp submitted_at = 4;
  string regulator_reference = 5; // Reference from FIU/FinCEN
}

// STRStatus tracks lifecycle
enum STRStatus {
  STR_STATUS_UNSPECIFIED = 0;
  STR_STATUS_DRAFT = 1;
  STR_STATUS_PENDING_REVIEW = 2;
  STR_STATUS_APPROVED = 3;
  STR_STATUS_SUBMITTED = 4;
  STR_STATUS_ACKNOWLEDGED = 5;
  STR_STATUS_REJECTED = 6;
}

// GenerateReportRequest creates regulatory report
message GenerateReportRequest {
  ReportType report_type = 1;
  string format = 2; // "xlsx", "xml", "pdf"

  // Time period
  google.protobuf.Timestamp start_date = 3;
  google.protobuf.Timestamp end_date = 4;

  // Filters
  string currency = 5;
  string country = 6;
}

// GenerateReportResponse returns report
message GenerateReportResponse {
  string report_id = 1;
  ReportType report_type = 2;
  string format = 3;
  bytes report_data = 4; // Binary report (Excel, PDF, etc.)
  string download_url = 5; // S3/signed URL
  google.protobuf.Timestamp generated_at = 6;
  ReportStatus status = 7;
}

// ReportType defines regulatory reports
enum ReportType {
  REPORT_TYPE_UNSPECIFIED = 0;
  REPORT_TYPE_AML_ANNUAL = 1;        // UAE FIU Annual Return
  REPORT_TYPE_PRU_MONTHLY = 2;       // FSRA Prudential Returns
  REPORT_TYPE_SAFEGUARDING = 3;      // Client money safeguarding
  REPORT_TYPE_PAYMENT_STATS = 4;     // Payment statistics (quarterly)
  REPORT_TYPE_CTR = 5;               // Currency Transaction Report
  REPORT_TYPE_TECH_RISK = 6;         // Technology risk report
  REPORT_TYPE_MODEL_VALIDATION = 7;  // Risk model validation
}

// ReportStatus tracks generation
enum ReportStatus {
  REPORT_STATUS_UNSPECIFIED = 0;
  REPORT_STATUS_GENERATING = 1;
  REPORT_STATUS_READY = 2;
  REPORT_STATUS_APPROVED = 3;
  REPORT_STATUS_SUBMITTED = 4;
  REPORT_STATUS_FAILED = 5;
}

// GetComplianceStatsRequest queries statistics
message GetComplianceStatsRequest {
  google.protobuf.Timestamp start_date = 1;
  google.protobuf.Timestamp end_date = 2;
}

// GetComplianceStatsResponse returns metrics
message GetComplianceStatsResponse {
  // Screening stats
  int64 total_screenings = 1;
  int64 screening_hits = 2;
  int64 screening_blocks = 3;
  int64 false_positives = 4;

  // STR stats
  int64 strs_filed = 5;
  int64 strs_pending = 6;

  // Travel Rule stats
  int64 travel_rule_checks = 7;
  int64 travel_rule_violations = 8;

  // Report stats
  map<string, int64> reports_generated = 9; // report_type -> count

  // Performance
  int64 p95_screening_duration_ms = 10;
  int64 p99_screening_duration_ms = 11;
}